#!/bin/bash

# ~/nia10/bin/actonit_nia_fx.bash

# This script should act on predictions in CSV files in ~/tmp/

# Demo:
# ~/nia10/bin/actonit_nia_fx.bash $1 $2 $3 $SELLBUY
# ~/nia10/bin/actonit_nia_fx.bash eur_gbp 22 7426 0
# The size is currently hardcoded at 100,000

# The value of $SELLBUY is generated by:
# ~/nia10/bin/actonit_nia.bash

cd ~/nia10/bin/

if [ $# -lt 4 ]
then
  echo You need to supply 4 params: pair idib port $SELLBUY
  echo Demo:
  echo $0 ' $pair $ibid $port 1'
  exit 1
fi

set -x

pair=$1
ibid=$2
port=$3
SELLBUY=$4
size=100000

# I should create a state tracker if I have none
if [ -f ~/nia10state_${pair}.csv ]
then
  /bin/ls -l  ~/nia10state_${pair}.csv
else
  echo state > ~/nia10state_${pair}.csv
  echo NEUTRAL >>  ~/nia10state_${pair}.csv
fi

tail -1 ~/nia10state_${pair}.csv

state=`tail -1 ~/nia10state_${pair}.csv`
echo 'state:'
echo $state

actnow=no
if [ $pair == eur_gbp ]; then
  symbol=EUR
  currency=GBP
  buy=BUY
  sell=SELL
  actnow=yes
fi

if [ $actnow == no ]; then
  echo $0 sees a problem with the pair
  exit 1
fi

if [ $state == 'NEUTRAL' ]
then
  echo I can buy or sell
  if [ $SELLBUY == 1 ]
  then
    echo I should $sell
    echo SHORT >>  ~/nia10state_${pair}.csv
    ~/nia10/bin/fx_order_node.bash $sell $size $symbol $currency $port $ibid
  else
    echo I should $buy
    echo LONG >>  ~/nia10state_${pair}.csv
    ~/nia10/bin/fx_order_node.bash $buy $size $symbol $currency $port $ibid
  fi
fi

if [ $state == 'SHORT' ]
then
  echo I can $buy
  if [ $SELLBUY == 0 ]
  then
    echo I should $buy
    echo NEUTRAL >>  ~/nia10state_${pair}.csv
    ~/nia10/bin/fx_order_node.bash $buy $size $symbol $currency $port $ibid
  fi
fi

if [ $state == 'LONG' ]
then
  echo I can $sell
  if [ $SELLBUY == 1 ]
  then
    echo I should $sell
    echo NEUTRAL >>  ~/nia10state_${pair}.csv
    ~/nia10/bin/fx_order_node.bash $sell $size $symbol $currency $port $ibid
  fi
fi

exit
